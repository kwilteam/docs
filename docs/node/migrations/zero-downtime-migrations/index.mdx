---
sidebar_position: 2
sidebar_label: "Zero Downtime Migrations"
id: zero-downtime-migrations
title: Zero Downtime Migrations
description: Zero Downtime Migrations
slug: /node/migrations/zero-downtime-migrations
---

Kwil supports zero-downtime migrations from v0.9 onwards. Any Kwil networks running v0.9 or later can upgrade their network without downtime using zero-downtime migrations. This document describes in detail the key phases involved in the zero-downtime migration process:
1. [Migration Proposal Phase:](#migration-proposal-phase) Validators propose and approve a migration plan, initiating the migration process.
2. [Activation Period: ](#activation-period) A migration is approved but not yet active. Validators prepare for the upcoming migration. No new migration proposals are allowed during this period.
3. [Migration Phase: ](#migration-phase) A migration is approved but not yet active. Validators prepare for the upcoming migration. No new migration proposals are allowed during this period.
5. [Migration Ends: ](#migration-ends) The old network halts at the proposed height, and the new network continues to operate.

![Migration Process](../../../../static/img/migration.jpg)

Refer to the [tutorial](/docs/node/migrations/zero-downtime-migrations/tutorial) for a step-by-step guide on how to upgrade your network using zero-downtime migrations.

## Migration Proposal Phase
A network migration is proposed by a validator using a special network governance resolution. A migration proposal has four key properties:

- `ActivationPeriod`: The amount of blocks before the migration is activated. It starts after the migration is approved via the voting system. The intention is to allow validators to prepare for the migration.
- `Duration`: The amount of blocks the migration will take to complete.
- `ChainID`: The new chain ID that the network will migrate to. A new chain ID should always be used for a new network to avoid cross-network replay attacks.
- `Timestamp`: The time at which the migration was proposed.

The Migration proposal needs to be approved by at least 2/3rd of the validators to start the migration process. The migration proposal will expire if the supermajority of the validators do not approve the proposal within `100800` blocks (roughly 7 days with a 6 second block interval). Once the migration proposal is approved, the network moves into migration mode after the specified activation period.

### Submit Migration Proposal

A validator operator can submit a migration proposal using the `kwil-admin migrate propose` command as shown below. Refer to the [submit migration proposal](/docs/ref/kwil-admin/migrate/propose) documentation for more details.

```bash
kwil-admin migrate propose --activation-period <activationPeriod> --duration <migrationDuration> --chain-id <newChainID> --rpcserver /tmp/kwil.sock
```

:::note
An off-chain communication is required among the validator operators to decide on the details of the migration proposal. One of the validators should submit the proposal to the network for approval. Only one proposal can be applied to the network during the lifetime of the network (per chain-id). Once the proposal is approved, all the other migration proposals will be rejected from the network and no new proposals can be submitted or approved.
:::

To check if the proposal is submitted successfully, we can get the list of pending migration proposals as shown below:

```bash
kwil-admin migration list --rpcserver /tmp/kwild.socket
```
This list will contain the proposal ID which is used by the validators to vote on the proposal. If it's a single validator network, the proposal will be automatically approved and removed from this pending list.


### Approve Migration Proposal

To start the migration, the migration proposal needs the approval from at least a supermajority of the validators. The validators can submit their vote approval on the migration proposal using the below command.

```bash
kwil-admin migration approve <proposal-id>
```

Operators can check the status of the proposal and the votes information as shown below:

```bash
kwil-admin migration status <proposal-id>
```

:::note
The migration proposal will expire if the supermajority of the validators do not approve the proposal within `100800` blocks (roughly 7 days with a 6sec block interval). Validators can resubmit the proposal after expiration.
:::

## Activation Period

Once >2/3 of the validators approve the migration proposal, the migration will start after the activation period. During this activation period, the network will reject any new migration proposals. The activation period allows all network participants to prepare for the upcoming migration.

## Migration Phase
The network migration begins once the activation period has elapsed since the approval of migration proposal. At the start of the migration, all the nodes on the old network generates a network snapshot and the genesis configuration required to initialize the new network. From this height onwards, all the nodes on the old network records state changes such as account spends or changes to user data on a per-block basis.

During migration, the old network will continue to operate but with limited capabilities. It will continue to support "inserts/updates/deletes". However, the following functionalities are disabled on the old network and will only execute on the new network:
- Schema Deploy and Drop
- Account Credits and Transfers
- Resolution Creation
- Resolution Approvals

### Start New Network

The new network should start in parallel with the old network at some point during the migration phase. Each validator in the new network should initialize their node with the genesis state from the snapshot generated by the old network at the start of the migration. The new network will start processing transactions and producing blocks as usual. All the changes made on the old network will be replicated to the new network during the migration period.

#### Replicate State Changes From Old Network

To enable validators in the new network to replicate changes from the old network, the new validators need to set the following configurations in the `config.toml` and `genesis.json` files.

`migrate_from` config in the `config.toml` file specifies the JSON-RPC address of the node from the old network that the new network should replicate the state changes from. 
```toml
[app]
migrate_from = "http://kwild-jsonrpc-server-address:8484"
```

The `migration` consensus parameter in the `genesis.json` file specifies the start and end block heights from which the state changes are to be replicated from the old network to the new network.
```json
{
    "consensus_params": {
        "migration": {
            "start_height": <start_height>,
            "end_height": <end_height>,
        },
    }
}
```
:::warning
`start_height` and `end_height` in the genesis file and `migrate_from` in the config file are mandatory to ensure that the new network stays in sync with the old network during the migration period. If neither are set, the new network will start with the state from the snapshot state, but doesn't include any state changes from the old network. If one of them is set but not other, the node will fail to start.
:::

#### Handling State Divergence

During migration period, as both old and new networks are running concurrently handing user transactions and replicating state changes from the old network, there is a possibility for the occurence of state divergences between the two networks. 
The migration process does its best to resolve the conflicts between the two networks using a set of conflict resolution principles. However, there might be some schemas where the conflicts cannot be resolved without any loss of data.

:::note
Operators should migrate to new network as soon as possible and redirect all the user transactions to the new network.
:::

User Dataset changeset conflicts are handled as follows:

- **Inserts**: Inserts from the old network will attempt to be applied to the new network, and any conflicts will be ignored, in favor of whatever already exists on the new network.
- **Updates**: The new network will check the pre-change value of the proposed update from the old network's changeset. If the new network's record for that primary key matches the pre-change value in the changeset, it will apply the change. If the values are not equal, it will discard the change in favor of what data exists on the new network
- **Deletes**: Similar to update, if the record matches the pre-change value in the changeset, it will be deleted. Otherwise, no change will be applied.

All spends from the old network should be replicated to the new network. If a spend from the old network would cause a user's balance to drop below zero, the entire balance will be spent, setting it to zero.

## Migration Ends

The old network halts after the `Duration` blocks since the start of the migration. The old network will no longer accept new transactions or produce new blocks with transactions. The RPC services remain available for querying the state of the network. Once the new network is fully synced with the old network, the old network can be safely decommissioned. The new network will continue to produce blocks and process transactions as usual.