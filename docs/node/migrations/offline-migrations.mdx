---
sidebar_position: 2
sidebar_label: "Offline Migrations"
id: offline-migrations
title: Offline Migrations
description: Offline Migrations
slug: /node/migrations/offline-migrations
---

This document provides a detailed guide on how to use offline migrations to establish a new network that integrates existing data from a previous network, using nodes that run on the updated version of the `kwild` binaries. The migration process involves the following steps:

1. [Halt the existing network](#halt-the-existing-network)
2. [Create network snapshot](#create-network-snapshot)
3. [Distribute the genesis state](#distribute-genesis-state)
4. [Start new network](#start-new-network)

Follow the steps below to upgrade the network to a new version of the `kwild` binaries:

## Halt the existing network
Offline migrations requires coordinated halting of the existing network to ensure that the network state is consistent across all nodes before proceeding to take a network snapshot. 

:::note
Offline coordination is required among the operators to decide on the block height at which the network should halt. 
:::

To halt the network, stop the your node and set the `halt` hardfork config in the `genesis.json` file to the agreed block height. Restart the node for `halt` to take effect and ensure that the network halts after the configured activation block height is reached.

```json
{
  "genesis_time": "2024-04-15T17:00:34.108598516Z",
  "chain_id": "kwil-chain-g1KPHOsY",
  "activations": {
    "halt": 1234000 // `halt` set to agreed upon block height
  },
  ...
}
```
Proceed to the next step to generate snapshots once the `halt` activation height has been reached.

## Create Network Snapshot

Use the `kwil-admin snapshot` tool to take a snapshot of the final state of the PostgresDB instance. For more details, refer to the [create database snapshots](/docs/ref/kwil-admin/snapshot/create) documentation. This tool connects directly to the database to capture its state and does not require the `kwild` process to be running.

```sh
kwil-admin snapshot create --snapdir ./network_snapshot --dbname postgres --host localhost --port 5432 --user kwild
```

This generates a compressed snapshot file and a template genesis file required to start the new network as shown below.

```sh
$ ls /path/to/snapdir
genesis.json            kwildb-snapshot.sql.gz
```

### Verify App Hash

The app hash set in the genesis file is generated based on the hash of the uncompressed snapshot. You can verify the app hash in the generated genesis file as follows

``` bash
kwil-admin setup genesis-hash --snapshot /path/to/snapdir/kwildb-snapshot.sql.gz
```

## Distribute Genesis State

The generated genesis file includes the genesis app hash, derived from the hash of the uncompressed snapshot file, and the genesis validators set to the validators from the previous network. If there are any changes to the validator set in the new network, modify the validator set manually to remove or add new validators. The rest of the configuration in the genesis file is set to defaults, so you should update it based on your requirements before distributing the genesis file.

:::warning
It is recommended that only one validator operator is responsible for generating, updating, and distributing the genesis state file to all other validators. This ensures that all validators are working from the same, consistent configuration.
:::

Distribute the `kwildb-snapshot.sql.gz` and the `genesis.json` files required to start the new network. 

## Start New Network

### Install Kwild Binaries

Install the new version of the `kwild` binaries. Refer to the [Installation](/docs/daemon/installation) documentation for more details on how to install the `kwild` binaries.

### Setup Root directory

Setup the new node's root directory with the genesis file and the snapshot data using the `kwil-admin setup init` command.

```
kwil-admin setup init --root-dir /new/node/dir --genesis ./path/to/genesis.json --genesis-state ./path/to/snapshot.sql.gz
```

:::note
Ensure that the `private_key` corresponding to the validator node are securely copied to the new node's root directory.
:::

### Configure Nodes To Use Snapshots

Configure `config.toml` with required settings, refer to the [Node Configuration](/docs/daemon/config/settings) documentation for more details.

Ensure that the `genesis_state` path in `config.toml` is set to the location of the snapshot file.

```TOML
#######################################################################
###                      App Config Options                         ###
#######################################################################

[app]

# Path to the snapshot file to restore the database from.
# Used during the network migration process.
genesis_state = "/path/to/snapshot/file"
```

:::info
To start a new network with the snapshot data, the genesis file must have the `app_hash` field set; otherwise, the network will start with an empty state.
The node will fail to start if the `app_hash` field is set in the `genesis.json` file but the `genesis_state` path is not provided in the `config.toml` file. 
:::

### Start Kwild Nodes

Once the genesis and config files are configured to use snapshots, start the node using the following command:

```bash
# use -h for more options. 
kwild -r /path/to/node/root/dir
```

:::tip
If your `genesis.json` file has multiple validators, you will need to start >2/3 of the validators before the network can start producing blocks.
:::

## Nodes Catching Up

Follow the same steps described in the [Start New Network](#start-new-network) section to configure and join the network. Nodes can either sync with the network using [statesync](../statesync) or blocksync. All nodes using blocksync need to have the genesis state locally to sync with the chain. Nodes using statesync do not need to download the genesis state locally.
