---
sidebar_position: 3
sidebar_label: "Tutorial"
id: network-migrations-tutorial
title: Tutorial
description: "Offline network migration guide"
slug: /node/migrations/offline-migrations/tutorial
---

This tutorial provides a step-by-step guide on how to upgrade the network to newer `kwild` versions using offline migrations. The migration process involves the following steps:
1. [Halt the existing network](#halt-the-existing-network)
2. [Create network snapshots](#create-network-snapshots)
3. [Distribute the genesis state](#distribute-genesis-state)
4. [Start the new network](#start-new-network)

## Halt the existing network
Offline migrations require a coordinated halting of the existing network to ensure that the network state is consistent across all nodes before proceeding to take a network snapshot. 

:::note
Offline coordination is required among the operators to decide on the block height at which the network should halt. 
:::

To halt the network, stop the your node and set the `halt` hardfork config in the `genesis.json` file to the agreed block height. Restart the node for `halt` to take effect and ensure that the network halts after the configured activation block height is reached.

```json
{
  "genesis_time": "2024-04-15T17:00:34.108598516Z",
  "chain_id": "kwil-chain-g1KPHOsY",
  "activations": {
    "halt": 1234000 // `halt` set to agreed upon block height
  },
  ...
}
```

## Create Network Snapshots
Once the network halts, create a network snapshot by running the below command. Refer to the [Network Snapshots](/docs/node/migrations/offline-migrations/network-snapshots#create-snapshot) documentation for more details.

```bash
kwil-admin snapshot create --snapdir /path/to/snapdir
```

## Distribute Genesis State

Before distributing the `snapshot` and the `genesis.json` files required to start the new network, ensure that the `genesis.json` file has:
1. The `app_hash` field set to the hash of the uncompressed snapshot file. Refer to the [Verify App Hash](/docs/node/migrations/offline-migrations/network-snapshots#verify-app-hash) section to ensure the hash is correct.
2. The `genesis validators` will be set to the validators from the previous network. Modify the validator set manually to remove or add new validators.
3. Ensure that the `chain_id` is set to the new network's chain id.
4. Update the rest of the configuration as per the requirements of the new network. 

Distribute the `snapshot.sql.gz` and `genesis.json` files to all the validators to start the new network.

## Start New Network
### Install Kwild Binaries

Install the new version of the `kwild` binaries. Refer to the [Installation](/docs/daemon/installation) documentation for more details on installing the `kwild` binaries.

### Setup Root directory

Copy the `snapshot.sql.gz`, `genesis.json` files downloaded [above](/docs/node/migrations/offline-migrations/network-snapshots#download-genesis-state) to the new node's root directory. Ensure that the valid `private_key` exists in the root_dir. 

```
root_dir
├── config.toml
├── private_key
├── genesis.json
├── snapshot.sql.gz
├── abci/
```
:::info
To start a new network with the snapshot data, the genesis file must have the `app_hash` field set; otherwise, the network will start with an empty state.
:::
s

###  Configure Node to Use Snapshot

Configure `config.toml` with required settings, refer to the [Node Configuration](/docs/daemon/config/settings) documentation for more details.

To initialize the node with the snapshot data, set the `genesis_state` path in `config.toml` to the location of the downloaded snapshot file. 

```TOML
#######################################################################
###                      App Config Options                         ###
#######################################################################

[app]

# Path to the snapshot file to restore the database from.
# Used during the network migration process.
genesis_state = "/path/to/snapshot/file"
```

:::note
The node will fail to start if the `app_hash` field is set in the `genesis.json` file but the `genesis_state` path is not provided in the `config.toml` file.
:::

### Start the Node

Once the genesis and config files are configured to use snapshots, start the node using the following command:

```bash
# use -h for more options. 
kwild -r /path/to/node/root/dir
```

## Nodes Catching Up

Follow the same steps described in the [Start New Network](#start-new-network) section to configure and join the network. Nodes can either sync with the network using `statesync` or `blocksync`.

If the node uses `blocksync`, the `genesis_state` path is mandatory to ensure that the node initializes with the same genesis initial state and replay all the historical blocks. If the node doesn't start from the same initial state, it will eventually fork itself off the chain during blocksync. 

If the node uses `statesync` to catch up with the network, the `genesis_state` path is not required in the `config.toml` file. The node will use the `statesync` protocol to catch up with the network as described in the [State Sync](/docs/node/statesync) documentation.

