---
sidebar_position: 1
sidebar_label: "Overview"
id: action-ext-overview
title: Action Extensions Overview
description: How to build Action Extensions in Go
slug: /extensions/actions/overview
---

Action extensions allow you to implement arbitrary logic directly into Kwil's smart contract language, [Kuneiform](/docs/category/kuneiform). This allows you to implement custom logic that is executed with each action that is performed on a Kwil database.

Action extensions are implemented using the `extensions/actions` package in the [`kwilteam/kwil-db`](https://github.com/kwilteam/kwil-db/blob/main/extensions/actions/actions.go) repo.

## `actions` package

To build an action extension, you must call the `ExtensionInitializer` function that returns the `ExtensionNamespace` interface to the `RegisterExtension` function.

### ExtensionInitializer

```go
type ExtensionInitializer func(ctx *DeploymentContext, service *common.Service, metadata map[string]string) (ExtensionNamespace, error)
```

ExtensionInitializer is a function that initializes an extension.

- `ctx` - The [DeploymentContext](#deploymentcontext). Includes information about the schema the extension is being used in.
- `service` - The [Service](#commonservice). Provides access to general application information to extensions (e.g. logger).
- `metadata` - The metadata for the extension.

Returns the extension namespace and an error if the extension fails to initialize.

#### Example

An example implementation of an `ExtensionInitializer` function is below:

<details>
    <summary>hello_world.go</summary>

```go title="hello_world.go"
package helloworld

import (
    "fmt"

    "github.com/kwilteam/kwil-db/extensions/actions"
    "github.com/kwilteam/kwil-db/common"
)

type HelloWorldExtension struct {
    greeting string
}

func InitializeHelloWorld(ctx *actions.DeploymentContext, service *common.Service, metadata map[string]string) (actions.ExtensionNamespace, error) {
    // Get the greeting from the metadata
    greeting, ok := metadata["greeting"]

    if !ok {
        // If the greeting is not provided, default to "Hello, "
        greeting = "Hello, "
    }

    return &HelloWorldExtension{greeting: greeting}, nil
}
```

</details>

### ExtensionNamespace

```go
type ExtensionNamespace interface {
	// Call executes the requested method of the extension.
	// It is up to the extension instance implementation to determine
	// if a method is valid, and to subsequently decode the arguments.
	// The arguments passed in as args, as well as returned, are scalar values.
	Call(scoper *ProcedureContext, app *common.App, method string, inputs []any) ([]any, error)
}
```

ExtensionNamespace is the shape of the interface that the `ExtensionInitializer` function should return.

- `Call` - Executes the requested method of the extension. It is up to the extension instance implementation to determine if a method is valid, and to subsequently decode the arguments. 
    - `scoper` - The [`ProcedureContext`](#procedurecontext). Contrains information about the action caller, the DBID, etc.
    - `app` - The [`App`](#commonapp). Provides access to the database to query and/or modify data.
    - `method` - The method to call.
    - `inputs` - The inputs to the method.


#### Example

An example implementation of an `ExtensionNamespace` interface is below:

<details>
    <summary>hello_world.go</summary>

```go title="hello_world.go"
package helloWorld

import (
    "fmt"

    "github.com/kwilteam/kwil-db/extensions/actions"
    "github.com/kwilteam/kwil-db/common"
)

...
/*
    Code from the previous example
*/
...

func (h *HelloWorldExtension) Call(scoper *actions.ProcedureContext, app *common.App, method string, inputs []any) ([]any, error) {
    switch method {
    case "sayHello":
        return h.sayHello(inputs...)
    default:
        return nil, fmt.Errorf("method %s not found", method)
    }
}

func (h *HelloWorldExtension) sayHello(inputs []any) ([]any, error) {
    // Ensure that only one name is passed
    if len(inputs) > 1 {
        return nil, fmt.Errorf("expected 1 argument for sayHello, got %d", len(inputs))
    }

    // Ensure that the name is a string
    name, ok := inputs[0].(string)

    if !ok {
        // If name is not a string, set it to "World"
        name = "World"
    }

    const greeting = h.greeting

    return []any{fmt.Sprintf("%s%s!", greeting, name)}, nil
}
```

</details>



### RegisterExtension

```go
func RegisterExtension(name string, ext ExtensionInitializer) error {}
```

Register extension registers an extension with the given name and extension initializer.

- `name` - The name of the extension.
- `ext` - The [`ExtensionInitializer`](#extensioninitializer) function.

Returns an error if the extension is already registered.

#### Example

An example of registering an extension is below:

<details>
    <summary>hello_world.go</summary>

```go title="hello_world.go"
package helloWorld

import (
    "github.com/kwilteam/kwil-db/extensions/actions"
)

...
/*
    Code from the previous examples
*/

const name = "hello_world"

func init() {
    err := actions.RegisterExtension(name, InitializeHelloWorld)
    if err != nil {
        panic(err)
    }
}
```

</details>

## Misc Types

Below are the types that are used in the `actions` package. 

Additional types that are nested within the below types can be found in the [actions package](https://github.com/kwilteam/kwil-db/blob/main/extensions/actions/actions.go).

### DeploymentContext

```go
type DeploymentContext struct {
	Ctx    context.Context
	Schema *common.Schema
}
```
DeploymentContext is the context for a dataset deployment transaction.

- `Ctx` - The context.
- `Schema` - The schema that the extension is being used in.

### common.Service

```go
type Service struct {
	Logger log.Logger
	ExtensionConfigs map[string]map[string]string
}
```

Service provides access to general application information to extensions.

- `Logger` - A logger for the application.
- `ExtensionConfigs` - A map of the nodes extensions and local configurations. It maps: `extension_name -> config_key -> config_value`.

### ProcedureContext

```go
type ProcedureContext struct {
	Ctx context.Context
	Signer []byte
	Caller string
	DBID string
	Procedure string
	Result *sql.ResultSet
}
```

ProcedureContext is the context for a procedure (i.e. action) execution.

- `Ctx` - The context of the current execution.
- `Signer` - The address or public key of the caller.
- `Caller` - The string identifier of the signer.
- `values` - The variables that are available to the action execution.
- `DBID` - The database identifier for the current scope.
- `Procedure` - The action being executed. If calling a nested action, it will be the last used action.
- `Result` - The result of the most recent SQL query.

### common.App

```go
type App struct {
	Service *Service
	DB sql.DB
	Engine Engine
}
```

App is an application that can modify and query the local database instance.

- `Service` - The [Service](#commonservice). Provides access to general application information to extensions (e.g. logger).
- `DB` - A connection to the underlying Postgres database.
- `Engine` - The underlying KwilDB engine, capable of storing and executing against Kuneiform schemas.
